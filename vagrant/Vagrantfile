# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/bookworm64"
  config.vm.hostname = "DevausYmparisto"
  config.vm.provision :salt do |salt|
    salt.minion_config = "salt/minion"
    salt.run_highstate = true
  end

  # Halutessasi web-demoa varten:
  config.vm.network "forwarded_port",
                    guest: 80,
                    host: 8080,
                    auto_correct: true

  # Resurssit
  config.vm.provider "virtualbox" do |vb|
    vb.memory = 2048   # 2 Gt RAM
    vb.cpus   = 2
  end

  # Vagrantfile on kansiossa vagrant/, salt-kansio on ../srv/salt
  config.vm.synced_folder "../srv/salt", "/srv/salt"

  # Asenna Salt ja aja teidän top.sls automaattisesti
  config.vm.provision "shell", inline: <<-SHELL
  set -e
  export DEBIAN_FRONTEND=noninteractive

  echo "==> Päivitetään pakettilista ja asennetaan päivitykset..."
  apt-get update
  apt-get -y upgrade

  # Asenna salt-minion jos puuttuu
  if ! command -v salt-call >/dev/null 2>&1; then
    echo "==> Installing salt-minion..."
    apt-get install -y salt-minion
    sed -i '/^master:/d' /etc/salt/minion || true
    grep -q '^file_client:' /etc/salt/minion || echo 'file_client: local' >> /etc/salt/minion
  fi

  echo "==> Running Salt from /srv/salt/top.sls ..."
  salt-call --local --file-root=/srv/salt state.apply
SHELL
end

