# -*- mode: ruby -*-
# vi: set ft=ruby :
Vagrant.configure("2") do |config|
  config.vm.box = "debian/bullseye64"
  config.vm.hostname = "DevausYmparisto"

  # Web-demoa varten (Apache/nginx → http://localhost:8080)
  config.vm.network "forwarded_port",
                    guest: 80,
                    host: 8080,
                    auto_correct: true

  # Resurssit
  config.vm.provider "virtualbox" do |vb|
    vb.memory = 2048
    vb.cpus   = 2
  end

  # Vagrantfile on kansiossa vagrant/, Salt-statet ovat ../srv/salt
  config.vm.synced_folder "../srv/salt", "/srv/salt"

  # Provisionointi: päivitykset + Salt asennus + masterless-konffi + top.sls
  config.vm.provision "shell", inline: <<-SHELL
    set -e
    export DEBIAN_FRONTEND=noninteractive

    echo "==> Päivitetään pakettilista ja asennetaan päivitykset..."
    apt-get update
    apt-get -y upgrade

    # Tarvitaan curl, jotta saadaan Saltin repo käyttöön
    apt-get install -y curl

    # Asenna salt-minion apt-reposta, jos salt-call puuttuu
    if ! command -v salt-call >/dev/null 2>&1; then
      echo "==> Installing salt-minion via Broadcom Salt apt repo..."

      # Varmistetaan keyrings-hakemisto
      mkdir -p /etc/apt/keyrings

      # Tuodaan SaltProject avain
      curl -fsSL https://packages.broadcom.com/artifactory/api/security/keypair/SaltProjectKey/public \
        | tee /etc/apt/keyrings/salt-archive-keyring.pgp >/dev/null

      # Lisätään Saltin apt-lähde
      curl -fsSL https://github.com/saltstack/salt-install-guide/releases/latest/download/salt.sources \
        | tee /etc/apt/sources.list.d/salt.sources >/dev/null

      # Päivitetään repo-listat ja asennetaan salt-minion
      apt-get update
      apt-get install -y salt-minion
    fi

    # Masterless: ei masteria, file_client local
    sed -i '/^master:/d' /etc/salt/minion || true
    if ! grep -q '^file_client:' /etc/salt/minion; then
      echo 'file_client: local' >> /etc/salt/minion
    fi

    # Varmistetaan että daemon on päällä
    systemctl enable salt-minion
    systemctl restart salt-minion

    echo "==> Running Salt from /srv/salt/top.sls ..."
    salt-call --local --file-root=/srv/salt state.apply
  SHELL
end
